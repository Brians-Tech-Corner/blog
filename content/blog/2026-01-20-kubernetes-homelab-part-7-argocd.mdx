---
title: "Building a Kubernetes Homelab: GitOps with ArgoCD"
date: "2025-12-20"
description: "Implementing GitOps workflows for automated, declarative deployments using ArgoCD"
tags: ["kubernetes", "homelab", "argocd", "gitops", "automation"]
series: "kubernetes-homelab"
seriesOrder: 4
draft: true
---

<Callout type="info">
This is Part 3 of the Kubernetes Homelab series. You should have a working K3s cluster from Part 2 before continuing.
</Callout>

## What is GitOps?

GitOps is a methodology where your Git repository becomes the single source of truth for your infrastructure and applications. Instead of manually applying changes with `kubectl`, you:

1. **Commit changes** to a Git repository
2. **ArgoCD detects** the changes automatically
3. **Cluster state syncs** to match Git

Benefits:

- ✅ **Audit trail** - every change is tracked in Git
- ✅ **Easy rollbacks** - revert to any previous commit
- ✅ **Collaboration** - use pull requests for changes
- ✅ **Declarative** - describe desired state, not steps
- ✅ **Automation** - no manual kubectl apply needed

## Installing ArgoCD

First, create a namespace and install ArgoCD:

```bash
# Create namespace
kubectl create namespace argocd

# Install ArgoCD
kubectl apply -n argocd -f \
  https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# Wait for pods to be ready
kubectl wait --for=condition=ready pod \
  --all -n argocd --timeout=300s
```

## Accessing the ArgoCD UI

### Port Forward Method (Quick Start)

```bash
kubectl port-forward svc/argocd-server -n argocd 8080:443
```

Now access the UI at https://localhost:8080

### Get the Admin Password

```bash
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d
```

Login with:
- **Username:** `admin`
- **Password:** (output from above command)

<Callout type="warning">
Change the admin password immediately after first login for security!
</Callout>

## Repository Structure

Create a Git repository for your cluster configuration. Here's the structure I use:

```text
k3s-homelab/
├── apps/
│   ├── production/
│   │   ├── homepage/
│   │   │   ├── deployment.yaml
│   │   │   ├── service.yaml
│   │   │   └── kustomization.yaml
│   │   └── monitoring/
│   └── staging/
├── infrastructure/
│   ├── cert-manager/
│   ├── longhorn/
│   └── traefik/
└── argocd/
    └── applications/
```

## Creating Your First Application

Let's deploy a simple homepage using GitOps. Create this file structure:

**apps/production/homepage/deployment.yaml:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homepage
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: homepage
  template:
    metadata:
      labels:
        app: homepage
    spec:
      containers:
      - name: homepage
        image: nginx:alpine
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
```

**apps/production/homepage/service.yaml:**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: homepage
  namespace: default
spec:
  selector:
    app: homepage
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
```

**apps/production/homepage/kustomization.yaml:**

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- deployment.yaml
- service.yaml
```

Commit and push these files to your repository.

## Creating an ArgoCD Application

Now tell ArgoCD to watch this directory:

**argocd/applications/homepage.yaml:**

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: homepage
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/your-username/k3s-homelab.git
    targetRevision: main
    path: apps/production/homepage
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  syncPolicy:
    automated:
      prune: true      # Delete resources that are removed from Git
      selfHeal: true   # Automatically sync when cluster state drifts
      allowEmpty: false
    syncOptions:
    - CreateNamespace=true
```

Apply this application:

```bash
kubectl apply -f argocd/applications/homepage.yaml
```

## Watching the Magic Happen

ArgoCD will now:

1. Clone your Git repository
2. Find the Kubernetes manifests
3. Apply them to your cluster
4. Monitor for any changes

Check the status:

```bash
# CLI method
argocd app get homepage

# Or watch in the UI
# https://localhost:8080
```

## Testing GitOps Workflow

Let's make a change to test the workflow:

1. **Edit the deployment** - change `replicas: 2` to `replicas: 3`
2. **Commit and push** the change
3. **Watch ArgoCD** automatically detect and apply the change

Within seconds, you'll have 3 replicas running!

```bash
kubectl get pods -l app=homepage
```

## App of Apps Pattern

To manage multiple applications, use the "app of apps" pattern:

**argocd/applications/root.yaml:**

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: root
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/your-username/k3s-homelab.git
    targetRevision: main
    path: argocd/applications
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

Now you only need to apply the root application, and it will manage all others!

## Best Practices

### 1. Use Separate Repos or Branches

- **Option A:** Separate repos for different environments
- **Option B:** Different branches (main, staging, production)
- **Option C:** Different directories with Kustomize overlays

### 2. Enable Auto-Sync Carefully

Start with manual sync for critical applications, then enable auto-sync once you're confident.

### 3. Use Kustomize for Environment Differences

```text
apps/
└── homepage/
    ├── base/
    │   ├── deployment.yaml
    │   └── service.yaml
    └── overlays/
        ├── production/
        │   └── kustomization.yaml
        └── staging/
            └── kustomization.yaml
```

### 4. Implement RBAC

Restrict who can deploy what:

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: team-a
spec:
  destinations:
  - namespace: team-a-*
    server: https://kubernetes.default.svc
  sourceRepos:
  - https://github.com/your-org/team-a-apps.git
```

## Troubleshooting

### Application Not Syncing

```bash
# Check application status
argocd app get homepage

# View sync history
argocd app history homepage

# Manual sync
argocd app sync homepage
```

### Git Authentication Issues

For private repositories, add credentials:

```bash
argocd repo add https://github.com/your-username/k3s-homelab.git \
  --username your-username \
  --password your-token
```

## What's Next?

In Part 4, we'll add distributed storage with Longhorn, enabling:

- Persistent volumes for databases
- Automatic backups
- Volume snapshots
- Disaster recovery

## Resources

- [ArgoCD Documentation](https://argo-cd.readthedocs.io/)
- [GitOps Principles](https://www.gitops.tech/)
- [My K3s Homelab Repo](https://github.com/brians-tech-corner/k3s-homelab)

<Callout type="success">
You now have a fully automated GitOps deployment pipeline! Any changes you push to Git will automatically be deployed to your cluster.
</Callout>
