---
title: "Building a Kubernetes Homelab: Setting Up K3s"
date: "2025-12-18"
description: "Installing and configuring a lightweight K3s cluster on your homelab hardware"
tags: ["kubernetes", "homelab", "k3s", "installation"]
series: "kubernetes-homelab"
seriesOrder: 2
draft: true
---

<Callout type="info">
This is Part 2 of the Kubernetes Homelab series. Make sure you've read Part 1 about planning and hardware.
</Callout>

## Why K3s?

K3s is a lightweight Kubernetes distribution perfect for homelabs and edge computing. Compared to full Kubernetes, K3s:

- **Uses 40% less memory** (runs in as little as 512MB RAM)
- **Single binary** - easy to install and update
- **Built-in components** - includes CoreDNS, Traefik, and local storage
- **ARM support** - perfect for Raspberry Pi
- **Production-ready** - fully certified Kubernetes distribution

## Architecture Overview

We'll be building a 3-node cluster:

```text
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  k3s-01     │  │  k3s-02     │  │  k3s-03     │
│  (Master)   │  │  (Worker)   │  │  (Worker)   │
│  10.0.1.11  │  │  10.0.1.12  │  │  10.0.1.13  │
└─────────────┘  └─────────────┘  └─────────────┘
      │                │                │
      └────────────────┴────────────────┘
                       │
              ┌─────────────────┐
              │   Switch/Router │
              │    10.0.1.1     │
              └─────────────────┘
```

## Prerequisites

Before we start, ensure:

- All nodes have Ubuntu 22.04 LTS installed
- Nodes can reach each other over the network
- You have SSH access to all nodes
- Each node has a static IP address

## Step 1: Prepare the Nodes

On **all nodes**, run these commands:

```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Disable swap (required for Kubernetes)
sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab

# Enable IP forwarding
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

sudo sysctl --system
```

## Step 2: Install K3s Master Node

On your **first node** (k3s-01):

```bash
# Install K3s as server (master) node
curl -sfL https://get.k3s.io | sh -s - server \
  --cluster-init \
  --tls-san 10.0.1.11 \
  --disable traefik \
  --write-kubeconfig-mode 644

# Verify installation
sudo k3s kubectl get nodes
```

The `--disable traefik` flag removes the default ingress controller - we'll install our own later.

### Get the Node Token

You'll need this to join worker nodes:

```bash
sudo cat /var/lib/rancher/k3s/server/node-token
```

Save this token - you'll need it in the next step.

## Step 3: Join Worker Nodes

On **k3s-02** and **k3s-03**:

```bash
# Replace with your master IP and token
export K3S_URL="https://10.0.1.11:6443"
export K3S_TOKEN="your-node-token-here"

curl -sfL https://get.k3s.io | sh -s - agent \
  --server $K3S_URL \
  --token $K3S_TOKEN
```

## Step 4: Configure kubectl Access

From your **workstation** (not the cluster nodes):

```bash
# Copy kubeconfig from master node
scp ubuntu@10.0.1.11:/etc/rancher/k3s/k3s.yaml ~/.kube/k3s-config

# Update the server address
sed -i 's/127.0.0.1/10.0.1.11/g' ~/.kube/k3s-config

# Set as default kubeconfig
export KUBECONFIG=~/.kube/k3s-config

# Test access
kubectl get nodes
```

You should see all three nodes in a `Ready` state:

```text
NAME      STATUS   ROLES                       AGE   VERSION
k3s-01    Ready    control-plane,etcd,master   5m    v1.28.4+k3s1
k3s-02    Ready    <none>                      3m    v1.28.4+k3s1
k3s-03    Ready    <none>                      3m    v1.28.4+k3s1
```

## Step 5: Deploy a Test Application

Let's verify everything works with a simple nginx deployment:

```bash
# Create a deployment
kubectl create deployment nginx --image=nginx

# Expose it as a service
kubectl expose deployment nginx --port=80 --type=ClusterIP

# Check the pods
kubectl get pods
```

You should see nginx running on one of your worker nodes!

## Troubleshooting

### Nodes Not Joining

If worker nodes fail to join:

```bash
# Check K3s service status on worker
sudo systemctl status k3s-agent

# View logs
sudo journalctl -u k3s-agent -f

# Common issues:
# - Firewall blocking port 6443
# - Wrong token
# - Time sync issues between nodes
```

### Network Issues

Ensure these ports are open:

- **6443**: Kubernetes API
- **10250**: Kubelet
- **8472**: Flannel VXLAN (if using Flannel)

```bash
# Check firewall rules
sudo ufw status

# Allow K3s ports
sudo ufw allow 6443/tcp
sudo ufw allow 10250/tcp
sudo ufw allow 8472/udp
```

## What's Next?

In Part 3, we'll set up GitOps with ArgoCD for automated deployments. You'll learn how to:

- Install and configure ArgoCD
- Connect your Git repository
- Deploy applications declaratively
- Implement automated rollbacks

## Configuration Files

All the configuration files and scripts from this post are available in my [GitHub repository](https://github.com/brians-tech-corner/k3s-homelab).

<Callout type="success">
Congratulations! You now have a working Kubernetes cluster. Take some time to explore and experiment before moving on to the next part.
</Callout>
